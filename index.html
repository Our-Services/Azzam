<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Academic Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f8fafc;
        }
        .color-1 { --class-color: #3b82f6; }
        .color-2 { --class-color: #22c55e; }
        .color-3 { --class-color: #eab308; }
        .color-4 { --class-color: #8b5cf6; }
        .class-card {
            border-left-width: 4px;
            border-color: var(--class-color);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .class-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .status-countdown {
            font-size: 2.25rem;
            font-weight: 800;
            direction: ltr; 
        }
        /* Toggle Switch Styles */
        .peer:checked ~ .toggle-dot {
            transform: translateX(100%);
            background-color: #ffffff;
        }
        .peer:checked ~ .toggle-bg {
            background-color: #4f46e5;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <script type="module">
        const firebaseConfig = {
          apiKey: "AIzaSyBMpLj1TKI4HJZeUEJ5iXekNZFv91lB1Cc",
          authDomain: "azzam-c8aad.firebaseapp.com",
          projectId: "azzam-c8aad",
          storageBucket: "azzam-c8aad.firebasestorage.app",
          messagingSenderId: "916342975413",
          appId: "1:916342975413:web:0cd396d037eabef93b07fc",
          measurementId: "G-L38V241YFY"
        };
        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
        const { getMessaging, getToken, onMessage } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js");
        const { getFirestore, doc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);
        const db = getFirestore(app);
        let fcmToken = null;

        function showMessage(message, type = 'info') {
            const messageEl = document.getElementById('notification-message');
            messageEl.textContent = message;
            messageEl.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
            if (type === 'success') messageEl.classList.add('bg-green-100', 'text-green-800');
            else if (type === 'error') messageEl.classList.add('bg-red-100', 'text-red-800');
            setTimeout(() => messageEl.classList.add('hidden'), 5000);
        }
        
        function getAlertsFromUI() {
            const alerts = [];
            document.querySelectorAll('[data-alert-group]').forEach((group, index) => {
                const minutes = group.querySelector('input[type="number"]').value;
                const enabled = group.querySelector('input[type="checkbox"]').checked;
                alerts.push({
                    minutes: parseInt(minutes, 10) || 0,
                    enabled: enabled
                });
            });
            return alerts;
        }

        async function requestAndSavePermission() {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    const vapidKey = "BDYWhY5UZEUZGA4PzhFEUO_fmIFEP4BnoeDBv0EVAvFh719Wb522tcvbz3RtTTeqjha_l-oQYJF43J-zvUGTZNE";
                    const currentToken = await getToken(messaging, { vapidKey: vapidKey });
                    if (currentToken) {
                        fcmToken = currentToken;
                        const alerts = getAlertsFromUI();
                        await setDoc(doc(db, "fcmTokens", fcmToken), { 
                            token: fcmToken, 
                            alerts: alerts,
                            createdAt: new Date() 
                        });
                        showMessage('Notifications enabled! You can now configure your alerts.', 'success');
                        document.getElementById('settings-panel').classList.remove('hidden');
                    } else showMessage('No registration token available.', 'error');
                } else showMessage('Unable to get permission to notify.', 'error');
            } catch (err) {
                console.error('An error occurred: ', err);
            }
        }

        async function saveReminderSettings() {
             if (!fcmToken) {
                try {
                    await requestAndSavePermission();
                    if (!fcmToken) return; 
                } catch(e) {
                     showMessage('Please enable notifications first.', 'error');
                     return;
                }
            }
            const alerts = getAlertsFromUI();
            try {
                await setDoc(doc(db, "fcmTokens", fcmToken), {
                    token: fcmToken,
                    alerts: alerts
                }, { merge: true });
                showMessage(`Reminder settings saved successfully.`, 'success');
            } catch (error) {
                console.error("Error updating settings: ", error);
                showMessage('Could not save settings.', 'error');
            }
        }

        onMessage(messaging, (payload) => {
            new Notification(payload.notification.title, { body: payload.notification.body });
        });

        window.requestAndSavePermission = requestAndSavePermission;
        window.saveReminderSettings = saveReminderSettings;
    </script>
    
    <script>
        const scheduleData=[{day:"Monday",subject:"Effective Writing",type:"Tutorial",code:"BLE3022",start:"08:00",end:"10:00",lecturer:"Melissa Wong Ling Lee",room:"C204",color:1},{day:"Monday",subject:"Fundamentals of Marketing",type:"Tutorial",code:"BBM1013",start:"11:00",end:"12:00",lecturer:"Nazliwati Mohamad",room:"C207",color:2},{day:"Tuesday",subject:"Business Accounting",type:"Tutorial",code:"BBA1093",start:"12:00",end:"13:00",lecturer:"Asst. Prof. Dr. Mohamad Aznillah",room:"C411",color:3},{day:"Tuesday",subject:"Logistics and Supply Chain Management",type:"Tutorial",code:"BBL1013",start:"17:00",end:"18:00",lecturer:"Ong Eu Chin",room:"C401",color:4},{day:"Tuesday",subject:"Fundamentals of Marketing",type:"Lecture",code:"BBM1013",start:"18:00",end:"20:00",lecturer:"Nazliwati Mohamad",room:"C302",color:2},{day:"Wednesday",subject:"Logistics and Supply Chain Management",type:"Lecture",code:"BBL1013",start:"17:00",end:"19:00",lecturer:"Ong Eu Chin",room:"C407",color:4},{day:"Thursday",subject:"Business Accounting",type:"Lecture",code:"BBA1093",start:"13:00",end:"15:00",lecturer:"Asst. Prof. Dr. Mohamad Aznillah",room:"GG07",color:3}];
        const daysOrder=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],dayNamesEn={Sunday:"Sunday",Monday:"Monday",Tuesday:"Tuesday",Wednesday:"Wednesday",Thursday:"Thursday",Friday:"Friday",Saturday:"Saturday"};function to12Hour(e){const[t,o]=e.split(":"),n=t>=12?" PM":" AM";let a=parseInt(t,10)%12;return a=a||12,`${a}:${o}${n}`}function groupClassesByDay(e){const t={};return daysOrder.forEach(e=>{t[e]=[]}),e.forEach(e=>{t[e.day]&&t[e.day].push(e)}),Object.keys(t).forEach(e=>{t[e].sort((e,t)=>e.start.localeCompare(t.start))}),t}function getAbsoluteTime(e,t){const o=new Date,n=t?e.start:e.end,a=n.split(":").map(Number),i=daysOrder.indexOf(e.day),r=o.getDay();let s=i-r;s<0&&(s+=7);const d=new Date(o);return d.setDate(o.getDate()+s),d.setHours(a[0],a[1],0,0),0===s&&d.getTime()<o.getTime()&&d.setDate(d.getDate()+7),d}
        function updateStatusWidget(e){const t=new Date;let o=null,n=null;const a=e.filter(e=>e.day===daysOrder[t.getDay()]).sort((e,t)=>e.start.localeCompare(t.start));for(const i of a){const r=60*parseInt(i.start.split(":")[0])+parseInt(i.start.split(":")[1]),s=60*parseInt(i.end.split(":")[0])+parseInt(i.end.split(":")[1]),d=60*t.getHours()+t.getMinutes();if(d>=r&&d<s){o=i;const l=a.indexOf(i)+1;l<a.length&&(n=a[l]);break}else if(d<r&&!n){n=i;break}}if(!o&&!n)for(let c=1;c<7;c++){const m=e.filter(e=>e.day===daysOrder[(t.getDay()+c)%7]).sort((e,t)=>e.start.localeCompare(t.start));if(m.length>0){n=m[0];break}}const g=document.getElementById("schedule-status-widget");let h="";o?(h=`<div class="bg-red-50 border-l-4 border-red-500 rounded-xl p-4 md:p-6 shadow-md text-left"><p class="text-xs text-red-600 font-semibold mb-1 uppercase">Current Class</p><h3 class="text-xl font-bold text-gray-800">${o.subject} (${o.type})</h3><p class="text-sm text-gray-600 mt-1">Ends on ${dayNamesEn[o.day]} at ${to12Hour(o.end)} in room ${o.room}</p><div class="mt-3 pt-2 border-t border-red-200"><p class="text-sm font-semibold text-gray-700">Time Remaining:</p><p class="status-countdown text-red-700">${(e=>{const t=Math.floor(e/1e3),o=Math.floor(t/3600),n=Math.floor(t%3600/60),a=t%60;return`${o>0?o+"h ":""}${n.toString().padStart(2,"0")}m ${a.toString().padStart(2,"0")}s`})(getAbsoluteTime(o,!1).getTime()-t.getTime())}</p></div></div>`):n?(h=`<div class="bg-green-50 border-l-4 border-green-500 rounded-xl p-4 md:p-6 shadow-md text-left"><p class="text-xs text-green-600 font-semibold mb-1 uppercase">Next Class</p><h3 class="text-xl font-bold text-gray-800">${n.subject} (${n.type})</h3><p class="text-sm text-gray-600 mt-1">Starts on ${dayNamesEn[n.day]} at ${to12Hour(n.start)} in room ${n.room}</p><div class="mt-3 pt-2 border-t border-green-200"><p class="text-sm font-semibold text-gray-700">Time Until Start:</p><p class="status-countdown text-green-700">${(e=>{const t=Math.floor(e/1e3),o=Math.floor(t/86400),n=Math.floor(t%86400/3600),a=Math.floor(t%3600/60),i=t%60;return o>0?`${o}d ${n}h ${a}m`:`${n>0?n+"h ":""}${a.toString().padStart(2,"0")}m ${i.toString().padStart(2,"0")}s`})(getAbsoluteTime(n,!0).getTime()-t.getTime())}</p></div></div>`):h='<div class="bg-gray-100 border-l-4 border-gray-400 rounded-xl p-4 md:p-6 shadow-md text-center"><h3 class="text-xl font-bold text-gray-700">Schedule Status</h3><p class="text-sm text-gray-500 mt-2">No current or upcoming classes for this week.</p></div>',g.innerHTML=h}
        function renderScheduleView(e,t){let o="";daysOrder.forEach(n=>{const a=groupClassesByDay(e)[n];a&&a.length>0&&(o+=`<div class="mb-8"><div class="flex items-center mb-4"><h3 class="text-2xl font-extrabold text-gray-800">${dayNamesEn[n]}</h3><div class="w-full h-px bg-gray-200 ml-4"></div></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">`,a.forEach(e=>{const n=`${to12Hour(e.start)} - ${to12Hour(e.end)}`;o+=`
        <div class="class-card color-${e.color} bg-white rounded-lg p-5 shadow-sm flex flex-col"><div class="flex justify-between items-start mb-2"><div><p class="text-sm font-bold text-gray-800">${e.code}</p><p class="text-xs text-gray-500">${e.type}</p></div><span class="text-sm font-semibold" style="color: var(--class-color);">${n}</span></div><h4 class="text-lg font-bold text-gray-900 mb-3 flex-grow">${e.subject}</h4><div class="border-t border-gray-100 pt-3 space-y-2 text-sm"><div class="flex items-center text-gray-600"><svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg><span>${e.lecturer}</span></div><div class="flex items-center text-gray-600"><svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg><span>${e.room}</span></div></div></div>`}),o+="</div></div>")}),""===o&&(o='<div class="text-center text-gray-500 p-8 bg-white rounded-lg shadow-sm"><p>No classes are scheduled.</p></div>'),t.innerHTML=o}
        document.addEventListener("DOMContentLoaded",()=>{renderScheduleView(scheduleData,document.getElementById("schedule-container")),updateStatusWidget(scheduleData),setInterval(()=>updateStatusWidget(scheduleData),5e3)});
    </script>
    
    <div class="max-w-7xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-2">My Academic Schedule</h1>
            <p class="text-lg text-gray-600">Set your custom class reminders!</p>
        </header>
        
        <div id="schedule-status-widget" class="mb-10 max-w-2xl mx-auto" style="direction: ltr;"></div>
        <div id="schedule-container"></div>
        
        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mt-12">
            <h2 class="text-2xl font-bold text-indigo-700 mb-4 border-b pb-3">Background Notifications</h2>
            <div id="notification-message" class="hidden border-l-4 p-4 mb-4 rounded-md"></div>
            <div class="bg-gray-50 p-6 rounded-lg space-y-4">
                <p class="text-gray-700">Click the button below to enable background notifications. You can receive class reminders even when this page is closed.</p>
                <button onclick="requestAndSavePermission()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-full transition duration-200 shadow-md w-full md:w-auto">
                    Enable Background Notifications
                </button>
                
                <div id="settings-panel" class="hidden pt-4 border-t border-gray-200">
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <!-- Alert 1 -->
                        <div data-alert-group>
                            <label for="reminder-minutes-1" class="block text-sm font-medium text-gray-700">Alert 1 (minutes)</label>
                            <div class="mt-1 flex items-center space-x-2">
                                <input type="number" id="reminder-minutes-1" value="15" min="1" class="block w-full border-gray-300 rounded-md shadow-sm">
                                <label for="alert-enabled-1" class="flex items-center cursor-pointer">
                                    <div class="relative">
                                        <input type="checkbox" id="alert-enabled-1" class="sr-only peer" checked>
                                        <div class="w-10 h-6 bg-gray-200 rounded-full toggle-bg"></div>
                                        <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform toggle-dot"></div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <!-- Alert 2 -->
                        <div data-alert-group>
                            <label for="reminder-minutes-2" class="block text-sm font-medium text-gray-700">Alert 2 (minutes)</label>
                            <div class="mt-1 flex items-center space-x-2">
                                <input type="number" id="reminder-minutes-2" value="30" min="1" class="block w-full border-gray-300 rounded-md shadow-sm">
                                <label for="alert-enabled-2" class="flex items-center cursor-pointer">
                                    <div class="relative">
                                        <input type="checkbox" id="alert-enabled-2" class="sr-only peer">
                                        <div class="w-10 h-6 bg-gray-200 rounded-full toggle-bg"></div>
                                        <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform toggle-dot"></div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <!-- Alert 3 -->
                        <div data-alert-group>
                            <label for="reminder-minutes-3" class="block text-sm font-medium text-gray-700">Alert 3 (minutes)</label>
                            <div class="mt-1 flex items-center space-x-2">
                                <input type="number" id="reminder-minutes-3" value="60" min="1" class="block w-full border-gray-300 rounded-md shadow-sm">
                                 <label for="alert-enabled-3" class="flex items-center cursor-pointer">
                                    <div class="relative">
                                        <input type="checkbox" id="alert-enabled-3" class="sr-only peer">
                                        <div class="w-10 h-6 bg-gray-200 rounded-full toggle-bg"></div>
                                        <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform toggle-dot"></div>
                                    </div>
                                </label>
                            </div>
                        </div>
                     </div>
                     <button onclick="saveReminderSettings()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md transition duration-200 shadow-sm">
                        Save All Settings
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

